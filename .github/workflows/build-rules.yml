name: Build and Update Sing-box Rulesets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *'
  push:
    branches:
      - main
    paths:
      - '**.json'
      - '**.txt'

jobs:
  build-rulesets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Download Sing-box
      # -------------------------
      - name: Download & setup sing-box
        run: |
          echo "Fetching latest sing-box release..."
          LATEST_URL=$(curl -s "https://api.github.com/repos/SagerNet/sing-box/releases/latest" \
            | jq -r '.assets[].browser_download_url' | grep 'linux-amd64.tar.gz')

          echo "Downloading: $LATEST_URL"
          wget -q -O sing-box.tar.gz "$LATEST_URL"

          echo "Extracting..."
          tar -xzf sing-box.tar.gz

          # 自动检测解压目录
          SBOX_DIR=$(tar -tf sing-box.tar.gz | head -1 | cut -d '/' -f1)
          mv "$SBOX_DIR/sing-box" ./sing-box
          chmod +x ./sing-box
          echo "Sing-box version:"
          ./sing-box version

      # -------------------------
      # Prepare rule folders
      # -------------------------
      - name: Create temporary rule directories
        run: |
          mkdir -p ./rules/direct-ip
          mkdir -p ./rules/direct-domain

      # -------------------------
      # Build direct-ip.srs
      # -------------------------
      - name: Build direct-ip.srs
        run: |
          echo "Downloading direct-ip rule JSON..."
          wget -q -P ./rules/direct-ip -i ./rule-list-ip.txt || { echo "wget failed" ; exit 1; }

          echo "Copy static base JSON..."
          cp ./direct-ip.json ./rules/direct-ip/

          echo "Removing non-JSON downloaded files..."
          find ./rules/direct-ip -type f ! -name "*.json" -delete
          find ./rules/direct-ip -type f -size 0 -delete

          cd ./rules/direct-ip

          echo "Merging IP rules..."
          jq -s '
            map(select(.rules)) |
            map(.rules) |
            add |
            { "version": 1, "rules": . }
          ' *.json > entry-ip.json

          cd ../..

          echo "Compiling direct-ip.srs..."
          ./sing-box rule-set compile ./rules/direct-ip/entry-ip.json -o direct-ip.srs

      # -------------------------
      # Build direct-domain.srs
      # -------------------------
      - name: Build direct-domain.srs
        run: |
          echo "Downloading direct-domain rule JSON..."
          wget -q -P ./rules/direct-domain -i ./rule-list.txt || { echo "wget failed"; exit 1; }

          cp ./direct-domain.json ./rules/direct-domain/

          echo "Removing non-JSON downloaded files..."
          find ./rules/direct-domain -type f ! -name "*.json" -delete
          find ./rules/direct-domain -type f -size 0 -delete

          cd ./rules/direct-domain

          echo "Merging domain rules..."
          jq -s '
            map(select(.rules)) |
            map(.rules) |
            add |
            { "version": 1, "rules": . }
          ' *.json > entry-domain.json

          cd ../..

          echo "Compiling direct-domain.srs..."
          ./sing-box rule-set compile ./rules/direct-domain/entry-domain.json -o direct-domain.srs

      # -------------------------
      # Build direct-emby.srs
      # -------------------------
      - name: Build direct-emby.srs
        run: |
          echo "Compiling direct-emby.srs..."
          ./sing-box rule-set compile ./direct-emby.json -o direct-emby.srs
          echo "direct-emby.srs built successfully."

      # -------------------------
      # Build proxy-domain.srs
      # -------------------------
      - name: Build proxy-domain.srs
        run: |
          echo "Compiling proxy-domain.srs..."
          ./sing-box rule-set compile ./proxy-domain.json -o proxy-domain.srs

      # -------------------------
      # Commit & Push
      # -------------------------
      - name: Commit and push generated files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add direct-ip.srs direct-domain.srs direct-emby.srs proxy-domain.srs

          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(bot): Auto update sing-box rulesets"
            git push
            echo "Rulesets updated & pushed."
          fi
